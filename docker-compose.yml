services:
  # 1. SCANNER SERVICE (Uses the main Dockerfile in the root)
  scanner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ml_scanner
    restart: always
    environment:
      # CRITICAL: For local docker-compose testing, use the internal Docker network name 'telegram_proxy'.
      # This points to the proxy service running on port 8001 inside the Docker network.
      TELEGRAM_PROXY_URL: "http://telegram_proxy:8001/send_alert" 
      # TELEGRAM_PROXY_URL: "https://model-breakup1-1.onrender.com/send_alert" # Use this only for remote deployment
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN} 
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}
    volumes:
      # Map current directory to container (useful for code changes)
      - .:/app
    ports:
      - "7860:7860"

  # 2. PROXY SERVICE (Uses its specific Dockerfile)
  # NOTE: This service is now UNCOMMENTED to allow for a full, self-contained local test environment.
  telegram_proxy:
    build:
      context: .
      dockerfile: ./proxy_service/Dockerfile.proxy
    container_name: telegram_proxy_server
    restart: always
    environment:
      # Proxy needs the real credentials to send to Telegram
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}
    volumes:
      # Map proxy service code
      - ./proxy_service:/app
    ports:
      - "8001:8001"